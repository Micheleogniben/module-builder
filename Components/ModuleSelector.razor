@inject IModuleService ModuleService
@inject NavigationManager Navigation
@inject ILogger<ModuleSelector> Logger
@inject ILoggingService LoggingService
@inject IErrorService ErrorService

@if (loading)
{
    <div class="loading">
        <div class="spinner"></div>
        <p>Loading modules...</p>
    </div>
}
else if (errorMessage != null)
{
    <div class="error-message">
        <p>@errorMessage</p>
    </div>
}
else if (modules.Count == 0)
{
    <p>No modules available.</p>
}
else
{
    <div class="module-grid">
        @foreach (var moduleId in modules)
        {
            <a href="/form/@moduleId" class="module-card" @onclick="() => OnModuleSelected(moduleId)">
                <h3>@moduleId</h3>
                <p>Click to start filling out this form</p>
            </a>
        }
    </div>
}

@code {
    private List<string> modules = new();
    private bool loading = true;
    private string? errorMessage;

    protected override async Task OnInitializedAsync()
    {
        try
        {
            Logger.LogDebug("Loading available modules");
            LoggingService.LogDebug("Loading available modules");
            
            modules = await ModuleService.GetAvailableModulesAsync();
            
            Logger.LogInformation("Loaded {Count} modules", modules.Count);
            LoggingService.LogInformation("Modules loaded successfully", new Dictionary<string, object> 
            { 
                { "ModuleCount", modules.Count },
                { "Modules", string.Join(", ", modules) }
            });
        }
        catch (Exception ex)
        {
            errorMessage = $"Error loading modules: {ex.Message}";
            Logger.LogError(ex, "Error loading modules");
            LoggingService.LogError("Error loading modules", ex, new Dictionary<string, object> 
            { 
                { "ErrorMessage", ex.Message } 
            });
            ErrorService.ShowError($"Si Ã¨ verificato un errore nel caricamento dei moduli: {ex.Message}", "Errore di caricamento");
        }
        finally
        {
            loading = false;
        }
    }

    private void OnModuleSelected(string moduleId)
    {
        Logger.LogInformation("User selected module: {ModuleId}", moduleId);
        LoggingService.LogInformation("Module selected", new Dictionary<string, object> { { "ModuleId", moduleId } });
    }
}

