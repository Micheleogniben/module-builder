@using Microsoft.AspNetCore.Components.Forms
@inject IModuleService ModuleService
@inject IDocumentService DocumentService
@inject IFormSubmissionService FormSubmissionService
@inject IJSRuntime JSRuntime
@inject ILogger<DynamicForm> Logger
@inject ILoggingService LoggingService
@inject IErrorService ErrorService

<EditForm OnValidSubmit="@HandleSubmit">
    
    @if (loading)
    {
        <div class="loading">
            <div class="spinner"></div>
            <p>Loading form...</p>
        </div>
    }
    else if (errorMessage != null)
    {
        <div class="error-message">
            <p>@errorMessage</p>
        </div>
    }
    else if (moduleConfig == null)
    {
        <div class="error-message">
            <p>Module not found.</p>
        </div>
    }
    else
    {
        <div class="card">
            <h2 class="card-title">@moduleConfig.Title</h2>

            @foreach (var question in moduleConfig.Questions)
            {
                <FormField 
                    Question="@question"
                    Value="@GetValue(question.FieldName)"
                    ValueChanged="@(value => SetValue(question.FieldName, value))"
                    IsInvalid="@(validationErrors.ContainsKey(question.FieldName))"
                    ErrorMessage="@(validationErrors.GetValueOrDefault(question.FieldName))" />
            }

            <div class="btn-group">
                <button type="submit" class="btn btn-primary" disabled="@isSubmitting">
                    @if (isSubmitting)
                    {
                        <text>Processing...</text>
                    }
                    else
                    {
                        <text>Generate Document</text>
                    }
                </button>
                <a href="/" class="btn btn-secondary">Cancel</a>
            </div>
        </div>

        @if (!string.IsNullOrEmpty(generatedDocument))
        {
            <DocumentPreview 
                Content="@generatedDocument" 
                ModuleId="@moduleConfig.ModuleId"
                OnDownload="@HandleDownload" />
        }

        @if (showSuccessMessage)
        {
            <div class="success-message">
                <p>Document generated successfully! You can download it below.</p>
            </div>
        }
    }
</EditForm>

@code {
    [Parameter] public string ModuleId { get; set; } = string.Empty;

    private ModuleConfig? moduleConfig;
    private Dictionary<string, object> formData = new();
    private Dictionary<string, string> validationErrors = new();
    private bool loading = true;
    private string? errorMessage;
    private string? generatedDocument;
    private bool isSubmitting = false;
    private bool showSuccessMessage = false;

    protected override async Task OnInitializedAsync()
    {
        await LoadModule();
    }

    private async Task LoadModule()
    {
        try
        {
            loading = true;
            Logger.LogDebug("Loading module: {ModuleId}", ModuleId);
            LoggingService.LogDebug("Loading module configuration", new Dictionary<string, object> { { "ModuleId", ModuleId } });
            
            moduleConfig = await ModuleService.LoadModuleAsync(ModuleId);
            
            if (moduleConfig == null)
            {
                errorMessage = $"Module '{ModuleId}' not found.";
                Logger.LogWarning("Module not found: {ModuleId}", ModuleId);
                LoggingService.LogWarning("Module not found", null, new Dictionary<string, object> { { "ModuleId", ModuleId } });
                ErrorService.ShowError($"Il modulo '{ModuleId}' non è stato trovato.", "Modulo non trovato");
            }
            else
            {
                Logger.LogInformation("Module loaded successfully: {ModuleId} with {QuestionCount} questions", 
                    ModuleId, moduleConfig.Questions?.Count ?? 0);
                LoggingService.LogInformation("Module loaded successfully", new Dictionary<string, object> 
                { 
                    { "ModuleId", ModuleId },
                    { "ModuleTitle", moduleConfig.Title ?? "" },
                    { "QuestionCount", moduleConfig.Questions?.Count ?? 0 }
                });
            }
        }
        catch (Exception ex)
        {
            errorMessage = $"Error loading module: {ex.Message}";
            Logger.LogError(ex, "Error loading module: {ModuleId}", ModuleId);
            LoggingService.LogError("Error loading module", ex, new Dictionary<string, object> 
            { 
                { "ModuleId", ModuleId },
                { "ErrorMessage", ex.Message }
            });
            ErrorService.ShowError($"Si è verificato un errore nel caricamento del modulo: {ex.Message}", "Errore di caricamento");
        }
        finally
        {
            loading = false;
        }
    }

    private string? GetValue(string fieldName)
    {
        if (formData.TryGetValue(fieldName, out var value))
        {
            return value?.ToString();
        }
        return null;
    }

    private void SetValue(string fieldName, string? value)
    {
        if (string.IsNullOrEmpty(value))
        {
            formData.Remove(fieldName);
        }
        else
        {
            formData[fieldName] = value;
        }
        
        // Clear validation error for this field
        validationErrors.Remove(fieldName);
    }

    private async Task HandleSubmit()
    {
        validationErrors.Clear();
        isSubmitting = true;
        showSuccessMessage = false;

        try
        {
            Logger.LogInformation("Form submission started for module: {ModuleId}", ModuleId);
            LoggingService.LogInformation("Form submission started", new Dictionary<string, object> 
            { 
                { "ModuleId", ModuleId },
                { "FieldCount", formData.Count }
            });

            // Validate required fields
            if (moduleConfig != null)
            {
                foreach (var question in moduleConfig.Questions)
                {
                    if (question.Required)
                    {
                        var value = GetValue(question.FieldName);
                        if (string.IsNullOrWhiteSpace(value))
                        {
                            validationErrors[question.FieldName] = "This field is required.";
                            Logger.LogDebug("Validation error: Required field {FieldName} is empty", question.FieldName);
                        }
                    }

                    // Email validation
                    if (question.QuestionType.ToLower() == "email")
                    {
                        var value = GetValue(question.FieldName);
                        if (!string.IsNullOrWhiteSpace(value) && !IsValidEmail(value))
                        {
                            validationErrors[question.FieldName] = "Please enter a valid email address.";
                            Logger.LogDebug("Validation error: Invalid email format for field {FieldName}", question.FieldName);
                        }
                    }
                }
            }

            if (validationErrors.Count > 0)
            {
                Logger.LogWarning("Form validation failed with {ErrorCount} errors for module: {ModuleId}", 
                    validationErrors.Count, ModuleId);
                LoggingService.LogWarning("Form validation failed", null, new Dictionary<string, object> 
                { 
                    { "ModuleId", ModuleId },
                    { "ErrorCount", validationErrors.Count },
                    { "Errors", string.Join(", ", validationErrors.Keys) }
                });
                var errorFields = string.Join(", ", validationErrors.Keys);
                ErrorService.ShowWarning($"Per favore, compila correttamente i seguenti campi: {errorFields}", "Validazione fallita");
                isSubmitting = false;
                return;
            }

            // Load template and process it
            if (moduleConfig != null)
            {
                Logger.LogDebug("Loading template for module: {ModuleId}", ModuleId);
                var template = await DocumentService.LoadTemplateAsync(ModuleId);
                if (template != null)
                {
                    Logger.LogDebug("Processing template for module: {ModuleId}", ModuleId);
                    generatedDocument = DocumentService.ProcessTemplate(template, formData);
                    showSuccessMessage = true;
                    
                    Logger.LogInformation("Document generated successfully for module: {ModuleId}", ModuleId);
                    LoggingService.LogInformation("Document generated successfully", new Dictionary<string, object> 
                    { 
                        { "ModuleId", ModuleId },
                        { "DocumentLength", generatedDocument?.Length ?? 0 }
                    });
                    ErrorService.ShowSuccess("Documento generato con successo! Puoi scaricarlo qui sotto.", "Documento generato");
                }
                else
                {
                    errorMessage = "Template not found for this module.";
                    Logger.LogWarning("Template not found for module: {ModuleId}", ModuleId);
                    LoggingService.LogWarning("Template not found", null, new Dictionary<string, object> { { "ModuleId", ModuleId } });
                    ErrorService.ShowError("Il template per questo modulo non è stato trovato.", "Template mancante");
                }
            }
        }
        catch (Exception ex)
        {
            errorMessage = $"Error processing form: {ex.Message}";
            Logger.LogError(ex, "Error processing form for module: {ModuleId}", ModuleId);
            LoggingService.LogError("Error processing form", ex, new Dictionary<string, object> 
            { 
                { "ModuleId", ModuleId },
                { "ErrorMessage", ex.Message }
            });
            ErrorService.ShowError($"Si è verificato un errore durante l'elaborazione del form: {ex.Message}", "Errore di elaborazione");
        }
        finally
        {
            isSubmitting = false;
        }
    }

    private async Task HandleDownload()
    {
        if (!string.IsNullOrEmpty(generatedDocument) && moduleConfig != null)
        {
            try
            {
                var fileName = $"{moduleConfig.ModuleId}_{DateTime.Now:yyyyMMdd_HHmmss}.md";
                Logger.LogInformation("Downloading document: {FileName} for module: {ModuleId}", fileName, ModuleId);
                LoggingService.LogInformation("Document download started", new Dictionary<string, object> 
                { 
                    { "ModuleId", ModuleId },
                    { "FileName", fileName }
                });
                
                await FormSubmissionService.DownloadDocumentAsync(
                    generatedDocument, 
                    fileName, 
                    "text/markdown");
                
                Logger.LogInformation("Document downloaded successfully: {FileName}", fileName);
                LoggingService.LogInformation("Document downloaded successfully", new Dictionary<string, object> { { "FileName", fileName } });
            }
            catch (Exception ex)
            {
                errorMessage = $"Error downloading document: {ex.Message}";
                Logger.LogError(ex, "Error downloading document for module: {ModuleId}", ModuleId);
                LoggingService.LogError("Error downloading document", ex, new Dictionary<string, object> 
                { 
                    { "ModuleId", ModuleId },
                    { "ErrorMessage", ex.Message }
                });
                ErrorService.ShowError($"Si è verificato un errore durante il download del documento: {ex.Message}", "Errore di download");
            }
        }
    }

    private bool IsValidEmail(string email)
    {
        try
        {
            var addr = new System.Net.Mail.MailAddress(email);
            return addr.Address == email;
        }
        catch
        {
            return false;
        }
    }
}

